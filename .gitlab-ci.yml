image: "rust:latest"

workflow:
    rules:
        - if: '$CI_PIPELINE_SOURCE == "web"'
          when: always
        - changes:
              - "src/**/*"
        - when: never

variables:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: "-D warnings"
    RUSTDOCFLAGS: "-D warnings"
    CARGO_HOME: $CI_PROJECT_DIR/.cargo

cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
        - .cargo/
        - target/

stages:
    - debug
    - static
    - test
    - metadata
    - build
    - release

show-versions:
    stage: debug
    script:
        - rustc --version
        - cargo --version
        - rustup --version

cargo-check:
    stage: static
    script:
        - cargo check --all-features --verbose --release

cargo-fmt:
    stage: static
    script:
        - rustup component add rustfmt
        - cargo fmt --all -- --check

cargo-clippy:
    stage: static
    script:
        - rustup component add clippy
        - cargo clippy --all-features --verbose --release

cargo-test:
    stage: test
    script:
        - cargo test --workspace --all-features --verbose --release

parse-metadata:
    stage: metadata
    rules:
        - if: '$CI_PIPELINE_SOURCE == "web"'
        - when: never
    script:
        - cargo metadata --no-deps --format-version 1 > metadata.json
        - CRATE_NAME=$(grep -oP '"name":\s*"\K[^"]+' metadata.json | head -n 1)
        - CRATE_VERSION=$(grep -oP '"version":\s*"\K[^"]+' metadata.json | head -n 1)
        - echo "$CRATE_NAME" > crate_name.txt
        - echo "$CRATE_VERSION" > crate_version.txt
    artifacts:
        paths:
            - crate_name.txt
            - crate_version.txt

build-binaries:
    stage: build
    rules:
        - if: '$CI_PIPELINE_SOURCE == "web"'
        - when: never
    needs:
        - parse-metadata
    image: rust:latest
    script:
        - CRATE_NAME=$(cat crate_name.txt)
        - CRATE_VERSION=$(cat crate_version.txt)
        - |
          TARGETS=(
            "x86_64-apple-darwin"
            "aarch64-apple-darwin"
            "x86_64-unknown-linux-gnu"
            "aarch64-unknown-linux-gnu"
            "x86_64-pc-windows-msvc"
          )

          mkdir dist

          for TARGET in "${TARGETS[@]}"; do
              rustup target add "$TARGET"
              cargo build --release --target "$TARGET"

              if [[ "$TARGET" == *"windows"* ]]; then
                  zip "dist/${CRATE_NAME}-${CRATE_VERSION}-${TARGET}.zip" \
                      "target/${TARGET}/release/${CRATE_NAME}.exe"
              else
                  tar -czf "dist/${CRATE_NAME}-${CRATE_VERSION}-${TARGET}.tar.gz" \
                      -C "target/${TARGET}/release" "${CRATE_NAME}"
              fi
          done
    artifacts:
        paths:
            - dist/
            - crate_name.txt
            - crate_version.txt

create-release:
    stage: release
    rules:
        - if: '$CI_PIPELINE_SOURCE == "web"'
        - when: never
    needs:
        - build-binaries
    script:
        - CRATE_NAME=$(cat crate_name.txt)
        - CRATE_VERSION=$(cat crate_version.txt)
        - |
          RELEASE_NOTES=$(cat release_notes.txt)
          
          PREV_VERSION=$(git tag --sort=-version:refname | grep -v "^v${CRATE_VERSION}$" | head -n 1)
          
          if [ -z "$PREV_VERSION" ]; then
              PREV_VERSION=$(git rev-list --max-parents=0 HEAD)
          fi
          
          FULL_DESCRIPTION="${RELEASE_NOTES}

          **Full Changelog**: ${CI_PROJECT_URL}/-/compare/${PREV_VERSION}...v${CRATE_VERSION}"
          
          ESCAPED_DESC=$(echo "$FULL_DESCRIPTION" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          
          curl --request POST \
            --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"name\": \"Release v${CRATE_VERSION}\",
              \"tag_name\": \"v${CRATE_VERSION}\",
              \"description\": \"${ESCAPED_DESC}\"
            }" \
            "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/releases"

          for file in dist/*; do
              BASENAME=$(basename "$file")
              UPLOAD_RESPONSE=$(curl --request POST \
                --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
                --form "file=@${file}" \
                "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/uploads")
              
              URL=$(echo "$UPLOAD_RESPONSE" | grep -oP '"url":\s*"\K[^"]+')

              curl --request POST \
                --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
                --header "Content-Type: application/json" \
                --data "{
                  \"name\": \"${BASENAME}\",
                  \"url\": \"${CI_PROJECT_URL}${URL}\"
                }" \
                "https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/releases/v${CRATE_VERSION}/assets/links"
          done