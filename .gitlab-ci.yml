workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - changes:
        - "src/**/*"
    - when: never

variables:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUSTDOCFLAGS: "-D warnings"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  DS_MAX_DEPTH: -1

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cargo/
    - target/

stages:
  - test
  - preparation
  - build
  - package
  - release

include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml
  - template: Jobs/Dependency-Scanning.gitlab-ci.yml

semgrep-sast:
  stage: test
  allow_failure: false
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - "**/*.rs"
  variables:
    SAST_EXCLUDED_PATHS: ".cargo/**"

secret_detection:
  stage: test
  allow_failure: false

gemnasium-dependency_scanning:
  stage: test
  allow_failure: false
  rules:
    - exists:
        - Cargo.lock
        - Cargo.toml

cargo-tests:
  image: rust:slim
  stage: test
  before_script:
    - rustup component add rustfmt clippy
    - set -x
  script:
    - cargo check --all-features --verbose --release
    - cargo fmt --all -- --check
    - cargo clippy --all-features --verbose --release
    - cargo test --workspace --all-features --verbose --release

prepare-metadata:
  image: alpine:latest
  stage: preparation
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  before_script:
    - apk add --no-cache grep git
    - set -x
  script:
    - export CRATE_NAME=$(grep -E '^name\s*=' Cargo.toml | head -1 | sed -E 's/name\s*=\s*"([^"]+)"/\1/')
    - export CRATE_VERSION=$(grep -E '^version\s*=' Cargo.toml | head -1 | sed -E 's/version\s*=\s*"([^"]+)"/\1/')
    - echo "CRATE_NAME=$CRATE_NAME" >> variables.env
    - echo "CRATE_VERSION=$CRATE_VERSION" >> variables.env
    - export TAG="v${CRATE_VERSION}"
    - git fetch --tags
    - PREV_VERSION=$(git tag --sort=-version:refname | grep -v "^${TAG}$" | head -n 1 || true)
    - |
      if [ -z "$PREV_VERSION" ]; then
        CHANGELOG="${CI_PROJECT_URL}/-/commits/${TAG}"
      else
        CHANGELOG="${CI_PROJECT_URL}/-/compare/${PREV_VERSION}...${TAG}"
      fi
    - NOTES="$(cat RELEASE-NOTES.md)"
    - |
      echo "${NOTES}

      **Full Changelog**: ${CHANGELOG}" > description.txt
  artifacts:
    paths:
      - description.txt
    reports:
      dotenv: variables.env

build-linux-x86:
  image: rust:slim
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  needs:
    - prepare-metadata
  before_script:
    - apt-get update && apt-get install -y libgtk-3-dev libxcb-shape0-dev libxcb-xfixes0-dev
    - set -x
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/$CRATE_NAME
    expire_in: 1 day

package-linux-x86:
  image: rust:slim
  stage: package
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  needs:
    - prepare-metadata
    - build-linux-x86
  before_script:
    - apt-get update && apt-get install -y dpkg-dev liblzma-dev
    - cargo install cargo-deb cargo-generate-rpm
    - set -x
  script:
    - mkdir -p dist
    - tar -czf "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.tar.gz" -C target/release "$CRATE_NAME"
    - cargo deb --no-build --output "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.deb"
    - cargo generate-rpm --output "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.rpm"
  artifacts:
    paths:
      - dist/*.tar.gz
      - dist/*.deb
      - dist/*.rpm
    expire_in: 1 day

upload-packages:
  image: registry.gitlab.com/gitlab-org/cli:latest
  stage: package
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  needs:
    - prepare-metadata
    - package-linux-x86
  script:
    - glab release upload "v${CRATE_VERSION}" "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.tar.gz#Linux (x86_64, tar.gz)#package"
    - glab release upload "v${CRATE_VERSION}" "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.deb#Linux (x86_64, deb)#package"
    - glab release upload "v${CRATE_VERSION}" "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.rpm#Linux (x86_64, rpm)#package"

create-release:
  image: registry.gitlab.com/gitlab-org/cli:latest
  stage: release
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  needs:
    - prepare-metadata
  script:
    - DESCRIPTION=$(cat description.txt)
    - |
      glab release create "v${CRATE_VERSION}" \
        --name "Release v${CRATE_VERSION}" \
        --notes "$DESCRIPTION" \
        --ref "$CI_COMMIT_SHA"