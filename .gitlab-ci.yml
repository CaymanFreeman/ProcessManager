workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - changes:
        - "src/**/*"
    - when: never

variables:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUSTDOCFLAGS: "-D warnings"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cargo/
    - target/

include:
  - template: Jobs/SAST.gitlab-ci.yml
  - template: Jobs/Secret-Detection.gitlab-ci.yml

stages:
  - debug
  - test
  - build
  - package
  - release

.rust-linux-template:
  image: rust:slim
  before_script:
    - apt-get update && apt-get install -y libgtk-3-dev libxcb-shape0-dev libxcb-xfixes0-dev

.rust-windows-template:
  tags:
    - saas-windows-medium-amd64
  cache:
    key: windows-rust-cache
    paths:
      - $env:USERPROFILE\.cargo
      - $env:USERPROFILE\.rustup
  before_script:
    - |
      if (!(Get-Command rustup -ErrorAction SilentlyContinue)) {
        Invoke-WebRequest -Uri https://win.rustup.rs/x86_64 -OutFile rustup-init.exe
        .\rustup-init.exe -y --default-toolchain stable --profile minimal
        Remove-Item rustup-init.exe
      }
    - $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
    - rustup update stable
    - rustup default stable

#.rust-macos-template:
#  tags:
#    - saas-macos-medium-m1
#  image: macos-14-xcode-15
#  before_script:
#    - rustup update stable
#    - rustup default stable

show-versions:
  extends: .rust-linux-template
  stage: debug
  script:
    - rustc --version
    - cargo --version
    - rustup --version

cargo-check:
  extends: .rust-linux-template
  stage: test
  script:
    - cargo check --all-features --verbose --release

cargo-fmt:
  extends: .rust-linux-template
  stage: test
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

cargo-clippy:
  extends: .rust-linux-template
  stage: test
  script:
    - rustup component add clippy
    - cargo clippy --all-features --verbose --release

cargo-test:
  extends: .rust-linux-template
  stage: test
  script:
    - cargo test --workspace --all-features --verbose --release

parse-metadata:
  extends: .rust-linux-template
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  script:
    - cargo metadata --no-deps --format-version 1 > metadata.json
    - CRATE_NAME=$(grep -oP '"name":\s*"\K[^"]+' metadata.json | head -n 1)
    - CRATE_VERSION=$(grep -oP '"version":\s*"\K[^"]+' metadata.json | head -n 1)
    - echo "CRATE_NAME=$CRATE_NAME" >> build.env
    - echo "CRATE_VERSION=$CRATE_VERSION" >> build.env
  artifacts:
    reports:
      dotenv: build.env

build-linux-x86:
  extends: .rust-linux-template
  stage: build
  needs:
    - parse-metadata
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/$CRATE_NAME
    expire_in: 1 day

build-windows-x86:
  extends: .rust-windows-template
  stage: build
  needs:
    - parse-metadata
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/$CRATE_NAME.exe
    expire_in: 1 day

#build-macos-x86:
#  extends: .rust-macos-template
#  stage: build
#  needs:
#    - parse-metadata
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "web"'
#    - when: never
#  script:
#    - cargo build --release
#  artifacts:
#    paths:
#      - target/release/$CRATE_NAME
#    expire_in: 1 day

package-linux:
  image: alpine:latest
  stage: package
  needs:
    - parse-metadata
    - build-linux-x86
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  before_script:
    - apk add --no-cache tar gzip
  script:
    - mkdir -p dist
    - tar -czf "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.tar.gz" -C target/release "$CRATE_NAME"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 day

package-windows:
  image: alpine:latest
  stage: package
  needs:
    - parse-metadata
    - build-windows-x86
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  before_script:
    - apk add --no-cache zip
  script:
    - mkdir -p dist
    - cd target/release
    - zip "../../dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-windows.zip" "${CRATE_NAME}.exe"
  artifacts:
    paths:
      - dist/*.zip
    expire_in: 1 day

#package-macos:
#  image: alpine:latest
#  stage: package
#  needs:
#    - parse-metadata
#    - build-macos-x86
#  rules:
#    - if: '$CI_PIPELINE_SOURCE == "web"'
#    - when: never
#  before_script:
#    - apk add --no-cache tar gzip
#  script:
#    - mkdir -p dist
#    - tar -czf "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-macos.tar.gz" -C target/release "$CRATE_NAME"
#  artifacts:
#    paths:
#      - dist/*.tar.gz
#    expire_in: 1 day

create-release:
  image: alpine/git:latest
  stage: release
  needs:
    - parse-metadata
    - package-linux
    - package-windows
#    - package-macos
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      git config user.email "ci@gitlab.com"
      git config user.name "GitLab CI"
      git tag -a "v${CRATE_VERSION}" -m "Release v${CRATE_VERSION}"
      git push https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git "v${CRATE_VERSION}"
      
      PREV_VERSION=$(git tag --sort=-version:refname | grep -v "^v${CRATE_VERSION}$" | head -n 1)
      if [ -z "$PREV_VERSION" ]; then
        PREV_VERSION=$(git rev-list --max-parents=0 HEAD)
      fi

      RELEASE_NOTES=$(cat release_notes.txt)
      CHANGELOG_LINK="${CI_PROJECT_URL}/-/compare/${PREV_VERSION}...v${CRATE_VERSION}"
      DESCRIPTION="${RELEASE_NOTES}\n\n**Full Changelog**: ${CHANGELOG_LINK}"
      
      RELEASE_RESPONSE=$(curl --silent --request POST \
        --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
        --header "Content-Type: application/json" \
        --data "$(jq -n \
          --arg name "Release v${CRATE_VERSION}" \
          --arg tag "v${CRATE_VERSION}" \
          --arg desc "$DESCRIPTION" \
          '{name: $name, tag_name: $tag, description: $desc}')" \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases")

      for file in dist/*; do
        FILENAME=$(basename "$file")
        echo "Uploading ${FILENAME}..."
      
        curl --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          --form "file=@${file}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/uploads" | \
        jq -r '.full_path' | \
        xargs -I {} curl --request POST \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          --data "name=${FILENAME}" \
          --data "url=${CI_PROJECT_URL}{}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/v${CRATE_VERSION}/assets/links"
      done