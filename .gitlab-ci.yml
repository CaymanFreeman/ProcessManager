workflow:
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: always
    - changes:
        - "src/**/*"
    - when: never

variables:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"
  RUSTDOCFLAGS: "-D warnings"
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  DS_MAX_DEPTH: -1

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - .cargo/
    - target/

stages:
  #  - test
  - build
  - package
  - release

#include:
#  - template: Jobs/SAST.gitlab-ci.yml
#  - template: Jobs/Secret-Detection.gitlab-ci.yml
#  - template: Jobs/Dependency-Scanning.gitlab-ci.yml
#
#semgrep-sast:
#  stage: test
#  rules:
#    - if: $CI_COMMIT_BRANCH
#      exists:
#        - "**/*.rs"
#  variables:
#    SAST_EXCLUDED_PATHS: ".cargo/**"
#
#secret_detection:
#  stage: test
#
#gemnasium-dependency_scanning:
#  stage: test
#  rules:
#    - exists:
#        - Cargo.lock
#        - Cargo.toml

.rust-linux-template:
  image: rust:slim
  before_script:
    - apt-get update && apt-get install -y libgtk-3-dev libxcb-shape0-dev libxcb-xfixes0-dev

#cargo-check:
#  extends: .rust-linux-template
#  stage: test
#  script:
#    - cargo check --all-features --verbose --release
#
#cargo-fmt:
#  extends: .rust-linux-template
#  stage: test
#  script:
#    - rustup component add rustfmt
#    - cargo fmt --all -- --check
#
#cargo-clippy:
#  extends: .rust-linux-template
#  stage: test
#  script:
#    - rustup component add clippy
#    - cargo clippy --all-features --verbose --release
#
#cargo-test:
#  extends: .rust-linux-template
#  stage: test
#  script:
#    - cargo test --workspace --all-features --verbose --release

parse-metadata:
  extends: .rust-linux-template
  stage: build
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
    - when: never
  script:
    - cargo metadata --no-deps --format-version 1 > metadata.json
    - CRATE_NAME=$(grep -oP '"name":\s*"\K[^"]+' metadata.json | head -n 1)
    - CRATE_VERSION=$(grep -oP '"version":\s*"\K[^"]+' metadata.json | head -n 1)
    - echo "CRATE_NAME=$CRATE_NAME" >> variables.env
    - echo "CRATE_VERSION=$CRATE_VERSION" >> variables.env
  artifacts:
    reports:
      dotenv: variables.env

build-linux-x86:
  extends: .rust-linux-template
  stage: build
  needs:
    - parse-metadata
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/$CRATE_NAME
    expire_in: 1 day

package-linux:
  image: alpine:latest
  stage: package
  needs:
    - parse-metadata
    - build-linux-x86
  before_script:
    - apk add --no-cache tar gzip
  script:
    - mkdir -p dist
    - tar -czf "dist/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.tar.gz" -C target/release "$CRATE_NAME"
  artifacts:
    paths:
      - dist/*.tar.gz
    expire_in: 1 day

upload-packages:
  image: curlimages/curl:latest
  stage: package
  needs:
    - parse-metadata
    - package-linux
  script:
    - |
      for file in dist/*; do
        if [ -f "$file" ]; then
          filename=$(basename "$file")
          curl --header "JOB-TOKEN: $CI_JOB_TOKEN" \
               --upload-file "$file" \
               "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${CRATE_NAME}/${CI_COMMIT_TAG}/$filename"
          echo "Uploaded: $filename"
        fi
      done

prepare-release:
  image: alpine:latest
  stage: release
  needs:
    - parse-metadata
    - upload-packages
  before_script:
    - apk add --no-cache curl jq
  script:
    - export TAG="v${CRATE_VERSION}"
    - |
      RELEASES_JSON=$(curl --silent \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases")
      if echo "$RELEASES_JSON" | jq -e 'type == "array"' > /dev/null; then
        PREV_VERSION=$(echo "$RELEASES_JSON" | jq -r '.[1].tag_name // empty')
      else
        PREV_VERSION=""
      fi
    - |
      if [ -z "$PREV_VERSION" ]; then
        PREV_VERSION=$(curl --silent \
          "$CI_API_V4_URL/projects/$CI_PROJECT_ID/repository/commits?per_page=1&order=asc" \
          | jq -r '.[0].id')
      fi
    - CHANGELOG="${CI_PROJECT_URL}/-/compare/${PREV_VERSION}...${TAG}"
    - NOTES="$(cat release_notes.md)"
    - |
      DESCRIPTION="${NOTES}\n\n**Full Changelog**: ${CHANGELOG}"
    - echo "DESCRIPTION=$DESCRIPTION" >> variables.env
  artifacts:
    reports:
      dotenv: variables.env

create-release:
  image: alpine:latest
  stage: release
  needs:
    - prepare-release
    - parse-metadata
  script:
    - echo "Creating release..."
  release:
    name: "Release v${CRATE_VERSION}"
    description: "$DESCRIPTION"
    tag_name: "v${CRATE_VERSION}"
    ref: "$CI_COMMIT_SHA"
    assets:
      links:
        - name: "Linux (x86_64, tar.gz)"
          url: "${CI_PROJECT_URL}/-/packages/generic/${CRATE_NAME}/${CI_COMMIT_TAG}/${CRATE_NAME}-${CRATE_VERSION}-x86_64-linux.tar.gz"